<div class="contenedor">
  <div class="formulario-container">
    <h3>
      @if(isEditing) {
        Editar Evento
      } @else {
        Crear Nuevo Evento
      }
    </h3>

    <form [formGroup]="form" (ngSubmit)="handleSubmit()" class="formulario-evento">
      <label for="titulo">T√≠tulo:</label>
      <input id="titulo" formControlName="titulo" placeholder="T√≠tulo del evento" />
      @if (titulo.dirty || titulo.touched) {
        @if (titulo.hasError('required')) {
          <span>El titulo es requerido</span>
        }
        @else if (titulo.hasError('minlength')) {
          <span>El campo "Titulo" debe tener como minimo 3 caracteres</span>
        }
      }

      <label for="fecha">Fecha:</label>
      <input id="fecha" formControlName="fecha" type="date" />
      @if (fecha.dirty || fecha.touched) {
        @if (fecha.hasError('required')) {
          <span>La fecha es requerida</span>
        }
        @else if (fecha.hasError('minDate')) {
          <span>La fecha debe ser un d√≠a futuro (no hoy ni fechas pasadas)</span>
        }
      }

      <label for="hora">Hora:</label>
      <input id="hora" formControlName="hora" type="time" />
      @if (hora.dirty || hora.touched) {
        @if (hora.hasError('required')) {
          <span>La hora es requerida</span>
        }
      }

      <label for="lugar">Lugar:</label>
      <input id="lugar" formControlName="lugar" placeholder="Lugar del evento" />
      @if (lugar.dirty || lugar.touched) {
        @if (lugar.hasError('required')) {
          <span>El lugar es requerido</span>
        }
        @else if (lugar.hasError('minlength')) {
          <span>El campo "Lugar" debe tener como minimo 3 caracteres</span>
        }
        @else if (lugar.hasError('hasNumbers')) {
          <span>El lugar no puede contener n√∫meros</span>
        }
      }

      <label for="categoria">Categor√≠a: </label>
      <select id = "categoria" formControlName = "categoria">
      <option value="" disabled selected>Seleccione una categoria</option>
      @for (categoria of categorias; track $index) {
        <option [value] = "categoria">{{ categoria }}</option>
      }
    </select>
    @if (categoria.dirty || categoria.touched) {
      @if (categoria.hasError('required')) {
        <span>La categoria es requerida</span>
      }
    }

      <label for="imagen">Imagen (URL):</label>
      <input id="imagen" formControlName="imagen" placeholder="https://..." />
        @if (imagen.dirty || imagen.touched) {
        @if (imagen.hasError('required')) {
          <span>La foto es requerida</span>
        }
        @else if (imagen.hasError('invalidUrl')) {
          <span>La URL debe empezar con "https://"</span>
        }
      }
  
      <label for="modoVenta">Modo de Venta:</label>
      <select id="modoVenta" formControlName="modoVenta" (change)="cambiarModoVenta()">
        <option value="sector">Venta por Sector</option>
        <option value="butaca">Venta por Butaca</option>
      </select>

      @if (form.get('modoVenta')?.value === 'sector') {
        <div class="sectores-block">
          <h4>Sectores</h4>
          <button type="button" (click)="agregarSector()">+ Agregar Sector</button>
          <div formArrayName="sectores">
            @for (s of sectores.controls; track $index; let i = $index) {
              <div [formGroupName]="i" class="sector-item">
                <div>
                  <label for="nombre">Nombre:</label>
                  <input id="nombre" formControlName="nombre" placeholder="Ej: VIP" />
                  @if (s.get('nombre')?.dirty || s.get('nombre')?.touched) {
                    @if (s.get('nombre')?.hasError('required')) {
                      <span class="error-inline">El nombre es requerido</span>
                    }
                    @else if (s.get('nombre')?.hasError('onlyLetters')) {
                      <span class="error-inline">El nombre solo puede contener letras</span>
                    }
                  } @else {
                    <span class="error-inline"></span>
                  }
                </div>
                <div>
                  <label for="capacidad">Capacidad:</label>
                  <input id="capacidad" formControlName="capacidad" type="number" />
                  @if (s.get('capacidad')?.dirty || s.get('capacidad')?.touched) {
                    @if (s.get('capacidad')?.hasError('required')) {
                      <span class="error-inline">La capacidad es requerida</span>
                    }
                    @else if (s.get('capacidad')?.hasError('positiveNumber')) {
                      <span class="error-inline">La capacidad debe ser mayor a 0</span>
                    }
                  } @else {
                    <span class="error-inline"></span>
                  }
                </div>
                <div>
                  <label for="precio">Precio:</label>
                  <input id="precio" formControlName="precio" type="number" />
                  @if (s.get('precio')?.dirty || s.get('precio')?.touched) {
                    @if (s.get('precio')?.hasError('required')) {
                      <span class="error-inline">El precio es requerido</span>
                    }
                    @else if (s.get('precio')?.hasError('positiveNumber')) {
                      <span class="error-inline">El precio debe ser mayor a 0</span>
                    }
                  } @else {
                    <span class="error-inline"></span>
                  }
                </div>
                <button type="button" (click)="eliminarSector(i)" class="btn-eliminar-item">üóëÔ∏è Eliminar</button>
              </div>
            }
          </div>
        </div>
      } @else {
        <div class="butacas-block">
          <h4>Configuraci√≥n de Butacas</h4>
          
          <div class="generador-butacas" [formGroup]="generadorButacas">
            <h5>üé´ Generador Autom√°tico de Butacas</h5>
            <p class="info-ayuda">
              Genera autom√°ticamente todas las butacas del evento especificando las filas y cantidad.
            </p>
            <div class="generador-campos">
              <div>
                <label for="filas">Filas <small>(A,B,C o A-E)</small>:</label>
                <input id="filas" formControlName="filas" placeholder="Ejemplo: A-E" />
                <small class="hint">üí° Usa comas (A,B,C) o gui√≥n (A-E)</small>
                @if (generadorButacas.get('filas')?.dirty || generadorButacas.get('filas')?.touched) {
                  @if (generadorButacas.get('filas')?.hasError('required')) {
                    <span class="error-inline">Las filas son requeridas</span>
                  }
                  @else if (generadorButacas.get('filas')?.hasError('invalidFilas')) {
                    <span class="error-inline">Formato de filas inv√°lido. Usa A-E o A,B,C</span>
                  }
                }
              </div>
              <div>
                <label for="butacasPorFila">Butacas por fila:</label>
                <input id="butacasPorFila" formControlName="butacasPorFila" type="number" placeholder="Ej: 10" min="1" />
                <small class="hint">üí° Cantidad de asientos por fila</small>
                @if (generadorButacas.get('butacasPorFila')?.dirty || generadorButacas.get('butacasPorFila')?.touched) {
                  @if (generadorButacas.get('butacasPorFila')?.hasError('required')) {
                    <span class="error-inline">Las butacas por fila son requeridas</span>
                  }
                  @else if (generadorButacas.get('butacasPorFila')?.hasError('positiveNumber')) {
                    <span class="error-inline">Las butacas por fila deben ser mayor a 0</span>
                  }
                   @else if (generadorButacas.get('butacasPorFila')?.hasError('max')) {
                    <span class="error-inline">Las butacas por fila no pueden ser mayor a 30</span>}
                }
              </div>
              <div>
                <label for="precioBase">Precio por butaca ($):</label>
                <input id="precioBase" formControlName="precioBase" type="number" placeholder="Ej: 1000" min="0" />
                <small class="hint">üí° Precio base para todas las butacas</small>
                @if (generadorButacas.get('precioBase')?.dirty || generadorButacas.get('precioBase')?.touched) {
                  @if (generadorButacas.get('precioBase')?.hasError('required')) {
                    <span class="error-inline">El precio es requerido</span>
                  }
                  @else if (generadorButacas.get('precioBase')?.hasError('positiveNumber')) {
                    <span class="error-inline">El precio debe ser mayor a 0</span>
                  }
                }
              </div>
            </div>
            
            @if (butacas.length > 0) {
              <div class="advertencia-reemplazo">
                ‚ö†Ô∏è Al generar se reemplazar√°n las {{ butacas.length }} butacas actuales
              </div>
            }
            
            <button type="button" (click)="generarButacas()" class="btn-generar">
              üé´ Generar Butacas Autom√°ticamente
            </button>
          </div>

          <hr />

          <div formArrayName="butacas">
            @if (butacas.length > 0) {
              <div class="butacas-header">
                <h5>Butacas Creadas</h5>
                <div class="info-butacas">Total: {{ butacas.length }} butacas</div>
              </div>
              
              <div class="opciones-butacas">
                <button type="button" (click)="agregarButaca()" class="btn-agregar">+ Agregar Butaca Manual</button>
                <button type="button" (click)="limpiarButacas()" class="btn-limpiar">üóëÔ∏è Limpiar Todas</button>
              </div>
              
              <div class="lista-butacas">
                @for (b of butacas.controls; track $index; let i = $index) {
                  @if (i < 20 || mostrarTodasButacas()) {
                    <div [formGroupName]="i" class="butaca-item">
                      <div class="butaca-info">
                        <span class="butaca-label">Fila {{ b.get('fila')?.value }} - #{{ b.get('numero')?.value }}</span>
                        <div class="campo-precio">
                          <label>Precio:</label>
                          <input formControlName="precio" type="number" min="0" step="0.01" />
                        </div>
                      </div>
                      <div class="butaca-errores">
                        @if (b.get('precio')?.dirty || b.get('precio')?.touched) {
                          @if (b.get('precio')?.hasError('required')) {
                            <span class="error-inline">Precio requerido</span>
                          }
                          @else if (b.get('precio')?.hasError('positiveNumber')) {
                            <span class="error-inline">Precio debe ser > 0</span>
                          }
                        }
                      </div>
                      <div class="butaca-controles">
                        <label class="checkbox-disponible">
                          <input formControlName="disponible" type="checkbox" />
                          Disponible
                        </label>
                        <button type="button" (click)="eliminarButaca(i)" class="btn-eliminar-item">üóëÔ∏è</button>
                      </div>
                    </div>
                  }
                }
                
                @if (butacas.length > 20 && !mostrarTodasButacas()) {
                  <div class="ver-mas">
                    <p>Mostrando 20 de {{ butacas.length }} butacas</p>
                    <button type="button" (click)="toggleMostrarTodas()" class="btn-ver-mas">
                      Ver todas las butacas
                    </button>
                  </div>
                } @else if (butacas.length > 20 && mostrarTodasButacas()) {
                  <button type="button" (click)="toggleMostrarTodas()" class="btn-ver-mas">
                    Ver menos
                  </button>
                }
              </div>
            } @else {
              <div class="sin-butacas">
                <p>üìã No hay butacas creadas a√∫n</p>
                <p>Usa el generador autom√°tico o agrega butacas manualmente</p>
                <button type="button" (click)="agregarButaca()" class="btn-agregar">+ Agregar Primera Butaca</button>
              </div>
            }
          </div>
        </div>
      }
    
        <button type="submit">
        @if(isEditing) {
          Actualizar Evento
        } @else {
          Guardar Evento
        }
      </button>
      
      
      
      @if(isEditing) {
        <button type="button" (click)="cancelarEdicion()" class="cancelar-btn">Cancelar</button>
      }
      
    </form>
  </div>
</div>


